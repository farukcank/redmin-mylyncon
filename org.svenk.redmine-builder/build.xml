<?xml version="1.0" encoding="UTF-8"?>
<project name="Redmine-Mylyn Build" default="main">
	<description>
            description
    </description>

	<import file="${buildHome}/build-files/common.xml" />
	<property file="${buildHome}/build-files/build.properties"/>

	<target name="-prepare">
		<tstamp />

		<property name="logDir" value="${buildDirectory}/logs"/>
		<mkdir dir="${logDir}"/>
		<record name="${logDir}/build.log"/>
		
		<exec executable="svn" output="${buildDirectory}/logs/svnupdate.log" >
			<arg value="update"/>
			<arg value="${buildHome}/svnfetch"/>
		</exec>
		
		<getbuildnr buildnrproperty="svnrevision"/>
		<property name="forceContextQualifier" value="${buildType}${DSTAMP}${TSTAMP}-r${svnrevision}"/>

	</target>
	
	<target name="-build" description="Call the Equinox Laucher">

		<java classname="org.eclipse.equinox.launcher.Main" fork="true" 
			failonerror="true" >
			<arg value="-application" />
			<arg value="org.eclipse.ant.core.antRunner" />
			<arg value="-buildfile" />
			<arg value="${buildfile}" />
			<arg value="${buildTarget}" />
			<jvmarg value="-Dbuilder=${buildHome}/build-files" />
			<jvmarg value="-DjavacFailOnError=true"/>
			<jvmarg value="-DbuildDirectory=${buildDirectory}"/>
			<jvmarg value="-DbaseLocation=${eclipseDir}"/>
			<jvmarg value="-DbuildHome=${buildHome}"/>
			<jvmarg value="-DforceContextQualifier=${forceContextQualifier}"/>
			<jvmarg value="-DbuildProperties=${buildHome}/build-files/build.properties"/>

			<classpath>
				<pathelement location="${equinoxjar}" />
			</classpath>

		</java>
	</target>

	<target name="main" description="Run the ..."  depends="-prepare" >
		<!--
		<antcall target="-build" />
		-->
		<antcall target="-mailsuccess" />
	</target>

	<target name="-mailsuccess" unless="build.failure">
		<path id="project.classpath">
			<pathelement location="${buildHome}/lib/mail.jar"/>
			<pathelement location="${buildHome}/lib/dsn.jar"/>
			<pathelement location="${buildHome}/lib/imap.jar"/>
			<pathelement location="${buildHome}/lib/mailapi.jar"/>
			<pathelement location="${buildHome}/lib/pop3.jar"/>
			<pathelement location="${buildHome}/lib/smtp.jar"/>
		</path>

		<mail mailhost="${mail.host}" user="${mail.user}" password="${mail.password}" subject="Build erfolgreich" >
			<from address="${mail.from}"/>
			<replyto address="${mail.replyto}"/>
			<to address="${mail.to}"/>
			<message>Build von Redmine-Mylyn Connector erfolgreich durchgef√ºhrt</message>
			<fileset dir="${logDir}">
				<include name="*.*"/>
			</fileset>
		</mail>
	</target>

</project>
